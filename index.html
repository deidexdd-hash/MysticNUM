<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MysticNUM ‚Äî –ú–∞—Ç—Ä–∏—Ü–∞ –°—É–¥—å–±—ã</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
</head>
<body>

    <div class="container animate-fade">
        <header>
            <h1 class="gold-text">MysticNUM</h1>
            <p class="subtitle">–î—Ä–µ–≤–Ω–∏–µ –∑–Ω–∞–Ω–∏—è –≤ —Ü–∏—Ñ—Ä–æ–≤–æ–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏</p>
        </header>

        <div class="glass-card main-form">
            <div class="input-group">
                <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                <input type="text" id="birthDate" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì" maxlength="10">
            </div>

            <div class="input-group">
                <label>–ü–æ–ª</label>
                <select id="gender">
                    <option value="–º—É–∂—Å–∫–æ–π">–ú—É–∂—Å–∫–æ–π</option>
                    <option value="–∂–µ–Ω—Å–∫–∏–π" selected>–ñ–µ–Ω—Å–∫–∏–π</option>
                </select>
            </div>

            <button id="calcBtn" onclick="handleCalculation()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –°—É–¥—å–±—É</button>
        </div>

        <div id="results" class="hidden">
            
            <div class="glass-card result-summary">
                <h3>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞</h3>
                <div id="additionalNums" class="nums-row"></div>
            </div>

            <div class="matrix-wrapper">
                <h3>–¶–∏—Ñ—Ä–æ–≤–∞—è –ú–∞—Ç—Ä–∏—Ü–∞</h3>
                <div class="matrix-container" id="matrixGrid">
                    <div class="matrix-cell" data-cell="1"><span>1</span><div class="val">-</div></div>
                    <div class="matrix-cell" data-cell="4"><span>4</span><div class="val">-</div></div>
                    <div class="matrix-cell" data-cell="7"><span>7</span><div class="val">-</div></div>
                    <div class="matrix-cell" data-cell="2"><span>2</span><div class="val">-</div></div>
                    <div class="matrix-cell" data-cell="5"><span>5</span><div class="val">-</div></div>
                    <div class="matrix-cell" data-cell="8"><span>8</span><div class="val">-</div></div>
                    <div class="matrix-cell" data-cell="3"><span>3</span><div class="val">-</div></div>
                    <div class="matrix-cell" data-cell="6"><span>6</span><div class="val">-</div></div>
                    <div class="matrix-cell" data-cell="9"><span>9</span><div class="val">-</div></div>
                </div>
            </div>

            <div class="glass-card interpretation-area">
                <h3>–ü–æ–ª–Ω–∞—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞</h3>
                <div id="interpretationText" class="prose"></div>
            </div>
        </div>
    </div>

    <script>
        // –£–∫–∞–∂–∏ –∑–¥–µ—Å—å URL —Ç–≤–æ–µ–≥–æ –∑–∞–¥–µ–ø–ª–æ–µ–Ω–Ω–æ–≥–æ –±—ç–∫–µ–Ω–¥–∞ –Ω–∞ Render
        const API_BASE_URL = "https://mystic2-1.onrender.com";

        async function handleCalculation() {
            const date = document.getElementById('birthDate').value;
            const gender = document.getElementById('gender').value;
            const btn = document.getElementById('calcBtn');

            if (!/^\d{2}\.\d{2}\.\d{4}$/.test(date)) {
                alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì");
                return;
            }

            btn.innerText = "–°—á–∏—Ç—ã–≤–∞–Ω–∏–µ —ç—Ñ–∏—Ä–∞...";
            btn.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api/calculate?date=${date}&gender=${gender}`);
                
                if (!response.ok) throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç");
                
                const data = await response.json();
                renderResults(data);
            } catch (err) {
                alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥.");
                console.error(err);
            } finally {
                btn.innerText = "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –°—É–¥—å–±—É";
                btn.disabled = false;
            }
        }

        function renderResults(data) {
            document.getElementById('results').classList.remove('hidden');

            // 1. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ (first.second.third.fourth)
            const addDiv = document.getElementById('additionalNums');
            addDiv.innerHTML = data.numbers.map(n => `<span>${n}</span>`).join('<i class="dot">.</i>');

            // 2. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —è—á–µ–µ–∫ –º–∞—Ç—Ä–∏—Ü—ã
            // –¢–≤–æ–π MatrixCalculator –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç full_array —Å —Ü–∏—Ñ—Ä–∞–º–∏
            const cells = document.querySelectorAll('.matrix-cell');
            cells.forEach(cell => {
                const num = parseInt(cell.getAttribute('data-cell'));
                // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ö–æ–∂–¥–µ–Ω–∏–π —Ü–∏—Ñ—Ä—ã –≤ –º–∞—Å—Å–∏–≤
                const count = data.full_array.filter(x => x === num).length;
                cell.querySelector('.val').innerText = count > 0 ? num.toString().repeat(count) : "–Ω–µ—Ç";
            });

            // 3. –¢–µ–∫—Å—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ (—á–∏—Å—Ç–∏–º Markdown –∏–∑ —Ç–≤–æ–∏—Ö —Ñ–∞–π–ª–æ–≤)
            const interpDiv = document.getElementById('interpretationText');
            interpDiv.innerHTML = formatText(data.interpretation);
            
            // –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function formatText(text) {
            if (!text) return "";
            return text
                .replace(/\*(.*?)\*/g, '<b>$1</b>') // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
                .replace(/\n/g, '<br>')            // –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
                .replace(/‚ùå|üîÆ|üåü|üìä/g, '<span class="emoji">$&</span>'); // –í—ã–¥–µ–ª–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏
        }
    </script>
</body>
</html>
